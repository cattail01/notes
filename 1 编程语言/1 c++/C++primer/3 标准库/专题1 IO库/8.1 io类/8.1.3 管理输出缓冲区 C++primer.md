[toc]

### 8.1.3 管理输出缓冲区

#### 输出缓冲区

##### 缓冲区与合并原理

* 每个输出流都管理一个缓冲区，用来保存程序读写的数据。

* 操作系统就可以将多个输出操作组合成单一的系统级写操作。

  可以提升性能

##### 缓冲刷新

* 程序正常结束，自动刷新缓冲区
* 缓冲区满时，需要刷新缓冲
* 使用操纵符（如 endl）来显示刷新缓冲区
* 可以用操纵符 unitbuf 设置流的内部状态，可以设置自动刷新的方式
* 一个输出流可能被关联到另一个流，读写被关联的流时，关联到的流的缓冲区会被刷新。

#### 用操纵符刷新缓冲区

* flush：刷新缓冲区
* ends：刷新缓冲区，添加一个空字符
* endl：刷新缓冲区并换行

#### unitbuf操纵符：控制自动刷新

* unitbuf 操纵符：在每次输出后都刷新缓冲区

* nounitbuf ：恢复使用正常的系统管理的缓冲区刷新机制

  ```C++
  cout << unitbuf;		// 所有输出操作后都会立即刷新缓冲区
  // 任何输出都立即刷新，无缓冲
  cout << nounitbuf;		// 回到正常的缓冲方式
  ```

*警告：如果程序崩溃，输出缓冲区不会被刷新*

#### 关联的输入输出流：让cout和cin互相刷新

##### cout和cin默认绑定，相互刷新

* 关联输入流和输出流：任何试图从输入流读取数据的操作都会先刷新关联的输出流。
* cin和cout默认绑定，因此cin会刷新cout的缓冲区
* 交互式系统通常应该关联输入流和输出流

##### 使用(i).tie

* x.tie(&o) 将流 x 关联到输出流 o

  ```C++
  cin.tie(&cout);	// 仅仅用来展示：将 cin 和 cout 关联在一起
  // old_tie 指向当前关联到 cin 的流 (如果有的话)
  ostream *old_tie = cin.tie(nullptr);// cin 不再与其他流关联
  cin.tie(&cerr);	// 将 cin 与 cerr 关联；cin 应该关联到 cout，这不是一个好主意
  cin.tie(old_tie);// 重建 cin 与 cout 的关联
  ```

  

